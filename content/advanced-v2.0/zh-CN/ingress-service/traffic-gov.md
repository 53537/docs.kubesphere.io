---
title: "流量治理"
---

KubeSphere 基于 istio 通过服务网格中部署的 Envoy sidecar 代理，为微服务应用的服务组件提供了流量治理的能力，允许用户修改负载均衡的方式，对连接池管理和熔断器进行细粒度的配置，通过故障注入来测试服务之间故障恢复策略的兼容性。

## 流量治理策略配置

点击流量治理拓扑图中的任意一个服务组件，例如点击 reviews，右侧可以看到流量治理策略配置的弹窗。

![](https://pek3b.qingstor.com/kubesphere-docs/png/20190415091333.png)

其中，流量治理的负载均衡算法支持以下两种策略


| **参数** | **参数说明** | 
|----|----|
| 负载均衡算法 <br> | - ROUND_ROBIN：轮询，默认负载均衡算法 <br> - LEAST_CONN：随机选取两个健康的主机，再从所选取的两个主机中选择一个链接数较少的主机 <br> -  RANDOM：从所有健康的主机中，随机选取一个    | 
| 会话保持 <br> | **根据HTTP header中的内容获取哈希：**  <br> 流量治理支持用户使用自定义 Key 来计算哈希，只需输入键的名称。 <br> **根据Cookie中的内容获取哈希：**  支持用户输入 Cookie 键的名称，转发方式则由设定的 Cookie 键对应的值来计算哈希，哈希相同的请求则会转发至同一个容器组中。例如我们设定 Cookie 中的 User 为键，则通过计算 User 对应的值的哈希来确认转发规则。     |


在微服务的一个服务组件中，流量治理的负载均衡策略可选择开启连接池管理和熔断器等配置

## 连接池管理

在连接池管理一栏，点击 「开启」即可配置连接池管理的各项参数。

| **参数** | **参数说明** | 
|----|----|
| 最大连接数 | 到目标主机 HTTP1 或 TCP 连接的最大数量。 | 
| 每连接最大请求数 | 对后端连接中最大的请求数量若设为 1 则会禁止 keep alive 特性。 | 
| 最大请求重试次数 | 在指定时间内对目标主机最大重试次数。 | 
| 连接超时时间 | TCP 连接超时时间。 | 
| 最大等待请求数 | 等待列队的长度，默认为 1024。 | 

![](https://pek3b.qingstor.com/kubesphere-docs/png/20190415115226.png)

## 熔断器

在熔断器一栏，点击 「开启」即可配置熔断器的各项参数。

| **参数** | **参数说明** | 
|----|----|
| 连续错误响应个数 | 再一个检查周期内，连续出现500及以上错误的个数，例502、503状态码。 | 
| 检查周期 (单位: s)   | 将会对检查周期内的响应码进行筛选。 | 
| 容器组隔离比例(单位: %)   | 允许容器组被隔离的最大比例。采用向上取整，若10个容器组，设为13%则最多会隔离2个容器组 |
| 最短隔离时间 (单位: s)   | 容器组第一次被隔离的时间，之后每次隔离时间为隔离次数与最短隔离时间的乘积 | 

![](https://pek3b.qingstor.com/kubesphere-docs/png/20190415115340.png)



